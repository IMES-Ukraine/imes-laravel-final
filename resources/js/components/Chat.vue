<template>
    <v-content>
        <template v-slot:sidebar>
            <div class="sidebar-content__block">
                <!-- –∞–∫—Ç–∏–≤–Ω–∞—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å—Å—ã–ª–∫–∞ —Å –∫–ª–∞—Å—Å–æ–º is-active -->
                <button type="button" class="btn btn-outline-primary btn-block is-active">
                    –ß–∞—Ç–∏
                </button>
                <div class="input-group input-group mt-5 mb-4">
                    <input type="text" id="filterId" class="form-control input-is-small input-has-append"
                           placeholder="–ø–æ—à—É–∫ –ø–æ ‚Ññ –∞–∫–∫–∞—É–Ω—Ç–∞"
                           v-model="filterId"
                           aria-label="–ø–æ—à—É–∫ –ø–æ ‚Ññ –∞–∫–∫–∞—É–Ω—Ç–∞" >
                    <div class="input-group-append">
                        <button class="button-group-input" aria-label="–∑–Ω–∞–π—Ç–∏" @click="findChat()">
                            <span class="icon-is-search"></span>
                        </button>
                    </div>
                </div>
            </div>
        </template>


        <div class="main-content__container" style="height: calc(100vh - 100px); ">
            <!-- main 4 -->
            <div class="main-chat">
                <div class="chat__block" id="chatBlock">
                    <div class="chat__contacts" style="overflow: hidden;">
                        <ul class="chat-contacts__list js-scroller-chat-list _scrollbar" id="contactList" >

                            <li v-for="item in list"
                                :class="{unread: item.unread, current: (item.id == currentChatId), 'chat-contacts__item': true}"
                                :key="item.id"
                                @click="chatWindow(item.id, item.id )">
                                {{ item.id }}
                                <div v-if="item.unread > 0" class="unread_count">{{ item.unread }}</div>
                            </li>
                        </ul>
                    </div>
                    <div class="chat__messages" id="chatWindow" style="overflow: hidden;">
                        <div class="chat__header">
                            –ß–∞—Ç –ø—ñ–¥—Ä–∏–º–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {{ currentChatId }}
                        </div>
                        <div class="chat__outer js-scroller-chat"
                            data-baron-v-id="0">
                            <div class="chat__body" id="chatBody">

                                <div v-for="item in chatData"
                                     class="chat__item">
                                    <div :class="  item.data.fromUser ? 'chat-message is-user' : 'chat-message is-my' ">
                                        {{ item.data.content }}
                                    </div>

                                </div>

                            </div>
                        </div>
                        <div class="chat__bottom">
                            <div class="chat-sender">
                                <input type="text" name="chat-message is-user" class="chat-sender__input"
                                       id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" v-model="newMessage">

                                <button id="sendButton" class="chat-sender__button"
                                        aria-label="–≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"
                                        @click="sendMessage(currentChatId, newMessage)">

                                </button>
                                <span id="current-user__id">
                                    <button
                                        class="chat-notify__button" data-request="onSubmitSupportResponse"
                                        data-request-flash=""
                                        style="border:none; background-color:transparent; outline:none;">üîî</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </v-content>

</template>
<style>
.current {
    border-color: #00B7FF;
    border-width: 3px;
}
.unread {
    background-color: lightpink;
    position: relative;
}

.unread_count {
    font-weight: bold;
    float: right;
}
.chat__header {
    font-size: 15px;
    font-weight: bold;
}

</style>

<script>


import VContent from "./templates/Content";
import NotificationSidebar from "./templates/notification/sidebar";
import {store} from "../firebase/app";

import {collection, setDoc, getDoc, doc, onSnapshot} from "firebase/firestore";


export default {
    name: "Chat",
    components: {VContent, NotificationSidebar},
    data() {
        return {
            account: null,
            body: null,
            list: [],
            sessionRef: null,
            filterId: null,
            chatData: [],
            currentChatId: null,
            currentChat: {},
            newMessage: ''
        }
    },
    mounted() {
        this.getList();
    },
    methods: {
        async getList() {
            onSnapshot(collection(store, "sessions"), (chatList) => {
                this.list = [];
                chatList.forEach((item) => {
                    this.list.push({id: item.id, unread: item.data().unreadCount});
                    //   console.log(item.id, " => ", item.data().unreadCount);
                });
            })
        },
        async getData(id) {
            this.currentChat = {};
            const docRef = doc(store, "sessions", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                this.currentChat = docSnap.data();
            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
            }
            return this.currentChat;
        },
        async chatWindow(documentId) {
            this.currentChatId = documentId;
            await this.getData(documentId);  //–ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç —á–∞—Ç–∞
            this.chatData = [];

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª—É—â–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø–∏—Å–µ–π —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
            onSnapshot(collection(doc(store, "sessions", documentId), 'messages'), (chatDoc) => {
                this.chatData = [];
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏
                chatDoc.forEach((item) => {
                    this.chatData.push({id: item.id, data: item.data()});
                });
                $(".chat__outer").scrollTop($(".chat__outer")[0].scrollHeight);
            });
// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            if (this.currentChat.unreadCount) {
                await setDoc(doc(store, 'sessions', documentId), {
                    unreadCount: 0,
                }).then(() => {
                    this.getList();
                });
            }
        },

        findChat() {
            this.chatWindow(this.filterId);
        },

        sendMessage(chatId) {
            console.log(chatId, this.newMessage);
            let time = String(Date.now());
            let messData = {
                content: this.newMessage,
                fromUser: false,
                isRead: false,
                time: time,
            };
            setDoc(doc(doc(store, "sessions", chatId), 'messages', time ), messData).then( () => {
                this.newMessage = '';
                // this.chatWindow(this.currentChatId)
            });
        },
        submitMessage(to, content) {

            this.sessionRef.doc(to).set({
                unreadCount: 0,
            }, {merge: true});

            this.sessionRef.doc(to).collection("messages").doc(String(Date.now())).set({
                content: content,
                fromUser: false,
                isRead: false,
                time: String(Date.now()),
            })
                .then(function () {
                    $('.chat-sender__input').val('');
                })
                .catch(function (error) {
                });

        },
    }
}
</script>

<style scoped>

</style>
